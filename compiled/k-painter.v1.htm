<!doctype html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=GBK" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>k line painter</title>
    <script>
function loading(a,b){this.canvas=(typeof a=="String"?document.getElementById(a):a);if(b){this.radius=b.radius||10;this.circleLineWidth=b.circleLineWidth||4;this.circleColor=b.circleColor||"lightgray";this.dotColor=b.dotColor||"gray"}else{this.radius=10;this.circelLineWidth=4;this.circleColor="lightgray";this.dotColor="gray"}}loading.prototype={show:function(){var a=this.canvas;if(!a.getContext){return}if(a.__loading){return}a.__loading=this;var b=a.getContext("2d");var d=this.radius;var e=[{angle:0,radius:1.5},{angle:3/d,radius:2},{angle:7/d,radius:2.5},{angle:12/d,radius:3}];var c=this;a.loadingInterval=setInterval(function(){b.clearRect(0,0,a.width,a.height);var h=c.circleLineWidth;var f={x:a.width/2-d,y:a.height/2-d};b.beginPath();b.lineWidth=h;b.strokeStyle=c.circleColor;b.arc(f.x,f.y,d,0,Math.PI*2);b.closePath();b.stroke();for(var g=0;g<e.length;g++){var j=e[g].currentAngle||e[g].angle;var k={x:f.x-(d)*Math.cos(j),y:f.y-(d)*Math.sin(j)};var l=e[g].radius;b.beginPath();b.fillStyle=c.dotColor;b.arc(k.x,k.y,l,0,Math.PI*2);b.closePath();b.fill();e[g].currentAngle=j+4/d}},50)},hide:function(){var a=this.canvas;a.__loading=false;if(a.loadingInterval){window.clearInterval(a.loadingInterval)}var b=a.getContext("2d");if(b){b.clearRect(0,0,a.width,a.height)}}};(function(){function b(){this.tapTimeLimit=500}Array.prototype.each=function(d,f,c){f=f||0;c=c||this.length-1;for(var e=f;e<=c;e++){d(this[e],this,e);if(this.breakLoop){this.breakLoop=false;break}}};b.prototype={preventDefaultEvent:function(c){if(c.preventDefault){c.preventDefault()}else{c.returnValue=false}},isTouchDevice:function(){return !!("ontouchstart" in window)},toMoney:function(c){return c.toFixed(2)},bigNumberToText:function(d){var c;var f=d/100000000;if(f>1){c=f.toFixed(2)+"亿"}else{var e=d/10000;if(e>1){c=e.toFixed()+"万"}else{c=d}}return c},getOffset:function(c){if(!isNaN(c.offsetX)&&!isNaN(c.offsetY)){return c}var h=c.target;if(h.offsetLeft==undefined){h=h.parentNode}var g=getPageCoord(h);var d={x:window.pageXOffset+c.clientX,y:window.pageYOffset+c.clientY};var f={offsetX:d.x-g.x,offsetY:d.y-g.y};return f},getPageCoord:function(d){var c={x:0,y:0};while(d){c.x+=d.offsetLeft;c.y+=d.offsetTop;d=d.offsetParent}return c},addLoadEvent:function(c){var d=window.onload;if(typeof d!="function"){window.onload=c}else{window.onload=function(){d();c()}}},addEvent:function(c,d,e,g){if(c.addEventListener){c.addEventListener(d,e,g);return true}else{if(c.attachEvent){var f=c.attachEvent("on"+d,e);return f}else{c["on"+d]=e}}},getEventTarget:function(c){return c.srcElement||c.target||c.relatedTarget},$id:function(c){return document.getElementById(c)}};window.extendObject=function(e,c){for(var d in e){c[d]=e[d]}};window.extendWindow=function(c){extendObject(c,window)};var a=new b();extendWindow(a);window.getQueryParam=function(f,c){var e=new RegExp("[?&]"+f+"=([^&]+)","i");var d=e.exec(c?window.top.location.search:location.search);if(d&&d.length>1){return decodeURIComponent(d[1])}else{return""}};window.debug=getQueryParam("debug");window.setDebugMsg=function(d){if(window.debug){try{var f="debug";var e=$id(f);if(!e){e=document.createElement("DIV");e.id=f;document.body.appendChild(e)}e.innerHTML=(window.debug==2?(d+"<br/>"+e.innerHTML):d)}catch(c){alert(d+";error:"+c)}}}})();var dashSize=2;function Painter(a,c,b){this.canvas=document.getElementById(a);if(!this.canvas.getContext){return}this.ctx=this.canvas.getContext("2d");this.data=b;this.paintImplement=c;this.width=this.canvas.width;this.height=this.canvas.height}Painter.prototype={paint:function(){var e=this.paintImplement;var b=this.data;var a=this.ctx;if(typeof e.initialize=="function"){e.initialize(this)}if(e.start){e.start.call(this)}if(typeof e.paintItems=="function"){e.paintItems.call(this)}else{var c=((typeof e.getDataLength=="function")?e.getDataLength.call(this):this.data.length);for(var d=0;d<c;d++){var f=e.getX?e.getX.call(this,d):undefined;var g=e.getY?e.getY.call(this,d):undefined;e.paintItem.call(this,d,f,g)}}if(e.end){e.end.call(this)}},drawHLine:function(a,g,h,e,d,c){var b=this.ctx;b.strokeStyle=a;if(h*10%10==0){h+=0.5}if(c&&c=="dashed"){var f=0;do{this.drawHLine(a,f,h,dashSize,1,"solid");f+=dashSize*2}while(f<e)}else{b.beginPath();b.moveTo(g,h);b.lineTo(g+e,h);b.stroke()}},drawVLine:function(a,g,i,c,f,e){var b=this.ctx;b.strokeStyle=a;if(g*10%10==0){g+=0.5}if(e&&e=="dashed"){var d=0;do{this.drawVLine(a,g,d,dashSize,1);d+=dashSize*2}while(d<c)}else{b.beginPath();b.moveTo(g,i);b.lineTo(g,i+c);b.stroke()}},setData:function(a){this.data=a},setPainterImplement:function(a){this.paintImplement=a}};var Ajax={};Ajax.request=function(e,g,a,c,f){f=f==undefined?true:f;var d=(window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):(window.XMLHttpRequest?new XMLHttpRequest():false));var b=document.getElementById(c);if(b&&f){b.loadingObj=new loading(b);b.loadingObj.show()}d.onreadystatechange=function(){if(d.readyState==4&&d.status==200){if(b&&f){b.loadingObj.hide()}a(d)}};d.open(e||"POST",g,true);if(d.overrideMimeType){d.overrideMimeType("text/xml")}d.send()};Ajax.get=function(d,a,b,c){Ajax.request("GET",d,a,b,c)};Ajax.post=function(d,a,b,c){Ajax.request("POST",d,a,b,c)};function crossLines(a){this.updateOptions(a)}crossLines.prototype={updateOptions:function(a){this.canvas=a.canvas;this.canvasId=this.canvas.id;this.horizontalDivId=this.canvasId+"_crossLines_H";this.verticalDivId=this.canvasId+"_crossLines_V";this.verticalRange=a.verticalRange||{y1:0,y2:this.canvas.height};this.horizontalRange=a.horizontalRange||{x1:0,x2:this.canvas.width};this.canvasPosition=getPageCoord(this.canvas);this.crossPoint=a.crossPoint;this.color=a.color||"black"},removeCrossLines:function(){var a=this.canvas;var b=a.id;var c=b+"_crossLines_H";var f=b+"_crossLines_V";var d=$id(c);if(d){d.style.display="none"}var e=$id(f);if(e){e.style.display="none"}},getHLine:function(){return $id(this.horizontalDivId)},getVLine:function(){return $id(this.verticalDivId)},setMouseEvents:function(a,b){this.hLineMouseEvt=a;this.vLineMouseEvt=b},updateCrossPoint:function(a){this.crossPoint=a;this.drawCrossLines()},drawCrossLines:function(){var a=this.canvas;var b=this.canvas.id;var f=b+"_crossLines_H";var i=b+"_crossLines_V";var h=this.verticalRange||{y1:0,y2:a.height};var g=this.horizontalRange||{x1:0,x2:a.width};var c=this.canvasPosition;if(this.crossPoint.x<g.x1||this.crossPoint.x>g.x2||this.crossPoint.y<h.y1||this.crossPoint.y>h.y2){this.removeCrossLines();return}var k=(a.style.zIndex||1)+1;var d=false;var e;if($id(f)){d=true;e=$id(f)}else{e=document.createElement("DIV");e.id=f}e.style.display="block";e.style.position="absolute";e.style.width=Math.round(g.x2-g.x1)+"px";e.style.height="1px";e.style.left=Math.round(c.x+g.x1)+"px";e.style.top=Math.round(this.crossPoint.y+c.y)+"px";e.style.backgroundColor=this.color;e.style.zIndex=k;if(!d){document.body.appendChild(e);if(typeof this.hLineMouseEvt=="function"){addEvent(e,"mouseover",this.hLineMouseEvt);addEvent(e,"mousemove",this.hLineMouseEvt)}}d=false;var j;if($id(i)){d=true;j=$id(i)}else{j=document.createElement("DIV");j.id=i}j.style.display="block";j.style.position="absolute";j.style.height=Math.round(h.y2-h.y1)+"px";j.style.width="1px";j.style.left=Math.round(this.crossPoint.x+c.x)+"px";j.style.top=Math.round(h.y1+c.y)+"px";j.style.backgroundColor=this.color;j.style.index=k;if(!d){document.body.appendChild(j);if(typeof this.vLineMouseEvt=="function"){addEvent(j,"mouseover",this.vLineMouseEvt);addEvent(j,"mousemove",this.vLineMouseEvt)}}}};function xAxis(a){this.options=a}xAxis.prototype={initialize:function(a){a.options=this.options},start:function(){var a=this.ctx;a.save();a.fillStyle=this.options.color;a.font=this.options.font;if(this.options.textBaseline){a.textBaseline=this.options.textBaseline}a.translate(this.options.region.x,this.options.region.y)},getY:function(){return 0},getX:function(a){if(a==0){return 0}var b=this.ctx.measureText(this.data[a]).width;if(a==this.data.length-1){return this.options.region.width-b}return(this.options.region.width*a/(this.data.length-1))-b/2},paintItem:function(a,b,c){this.ctx.fillText(this.data[a],b,c)},end:function(){this.ctx.restore()}};function Tip(a){extendObject(a,this)}Tip.prototype={getElementId:function(){return this.canvas.id+"_tip"},_getRightLimit:function(){return this.canvasRange.x+this.canvasRange.width},_getLeftLimit:function(){return this.canvasRange.x},_getTopLimit:function(){return this.canvasRange.y},_getBottomLimit:function(){return this.canvasRange.y+this.canvasRange.height},show:function(i,d){if(i){this.relativePoint=i}if(d){this.innerHTML=d}var g=$id(this.getElementId());var j=this.size;var e=this.offsetToPoint;var h=this.position;var i=this.relativePoint;var a=getPageCoord(this.canvas);var n=h.y||i.y;var m=h.x||i.x;var k=0;var l=0;if(h.x){k=h.x}else{if(g){var b=parseInt(g.style.left)-a.x;if(b>m){if(e+m+j.width>this._getRightLimit()){b=m-e-j.width}else{b=m+e}}else{if(m-e-j.width>this._getLeftLimit()){b=m-e-j.width}else{b=m+e}}k=b}else{k=m+e;if(k>this._getRightLimit()){k=m-e-j.width}}}if(h.y){l=h.y}else{if(g){var c=parseInt(g.style.top)-a.y;if(c>n){if(e+n+j.height>this._getBottomLimit()){c=n-e-j.height}else{c=n+e}}else{if(n-e-j.height>this._getTopLimit()){c=n-e-j.height}else{c=n+e}}l=c}else{l=n+e;if(l>this._getBottomLimit()){l=n-e-j.height}}}if(!g){g=document.createElement("DIV");g.id=this.getElementId();var f=this.opacity||100;g.style.cssText="-moz-opacity:."+f+"; filter:alpha(opacity="+f+"); opacity:"+(f/100)+';line-height:18px;font-family:Arial,"宋体";font-size:9pt;padding:4px;';g.style.position="absolute";g.style.zIndex=4+(this.canvas.style.zIndex||1);g.style.backgroundColor="white";g.style.border="1px solid gray";g.style.width=this.size.width+"px";g.style.height=this.size.height+"px";if(this.cssClass){g.className=this.cssClass}document.body.appendChild(g)}k=a.x+k;l=a.y+l;g.style.left=k+"px";g.style.top=l+"px";g.style.display="block";g.innerHTML=this.innerHTML},hide:function(){var a=$id(this.getElementId());if(a){a.style.display="none"}},update:function(b,a){this.relativePoint=b;this.innerHTML=a;this.show()}};function linePainter(a){this.options=a}linePainter.prototype={initialize:function(a){a.options=this.options},getDataLength:function(){return this.options.getDataLength.call(this)},getX:function(a){return(a+1)*(this.options.region.width/this.options.maxDotsCount)},start:function(){var a=this.ctx;var d=this.options;var e=d.region;a.save();a.translate(e.x,e.y+e.height/2);var b=0;var c=this;this.data.items.each(function(g){var f=Math.abs(d.middleValue-d.getItemValue(g));b=Math.max(f,b)});this.maxDiff=b;a.beginPath();a.strokeStyle=d.lineColor},end:function(){this.ctx.stroke();this.ctx.restore()},getY:function(b){var c=this.options;var a=c.getItemValue(this.data.items[b])-c.middleValue;return 0-a*c.region.height/2/this.maxDiff},paintItem:function(b,c,d){var a=this.ctx;if(b==0){a.moveTo(c,d)}else{a.lineTo(c,d)}}};function volumePainter(a){this.options=a;this.barWidth=a.bar.width;this.spaceWidth=a.region.width/a.maxDotsCount-a.bar.width;if(this.spaceWidth<1){this.spaceWidth=0}if(this.barWidth*a.maxDotsCount>a.region.width){this.barWidth=a.region.width/a.maxDotsCount}}volumePainter.prototype={initialize:function(a){a.options=this.options;a.barWidth=this.barWidth;a.spaceWidth=this.spaceWidth},getDataLength:function(){return this.options.getDataLength.call(this)},getX:function(a){return this.options.region.x+a*(this.barWidth+this.spaceWidth)},start:function(){var a=this.ctx;var c=this.options;var d=c.region;a.save();var b=0;this.data.items.each(function(e){b=Math.max(b,e.volume)});this.maxVolume=b;a.fillStyle=c.bar.color},end:function(){this.ctx.restore()},getY:function(b){var a=this.options.region.y+(this.maxVolume-this.data.items[b].volume)*this.options.region.height/this.maxVolume;return a},paintItem:function(b,c,d){var a=this.ctx;a.beginPath();a.rect(c,d,this.barWidth,this.options.region.y+this.options.region.height-d);a.fill()}};function yAxis(a){this.scalerOptions=a}yAxis.prototype={initialize:function(a){a.scalerOptions=this.scalerOptions},start:function(){var a=this.ctx;a.save();if(typeof this.scalerOptions.color=="string"){a.fillStyle=this.scalerOptions.color}a.font=this.scalerOptions.font;a.translate(this.scalerOptions.region.x,this.scalerOptions.region.y);if(this.scalerOptions.textBaseline){a.textBaseline=this.scalerOptions.textBaseline}},end:function(){this.ctx.restore()},getX:function(a){if(this.scalerOptions.align=="left"){return 0}var b=this.ctx.measureText(this.data[a]).width;return this.scalerOptions.region.width-b},getY:function(a){if(a==0){return 0}if(a==this.data.length-1){return this.scalerOptions.region.height-this.scalerOptions.fontHeight}return(this.scalerOptions.region.height*a/(this.data.length-1)-this.scalerOptions.fontHeight/2)},paintItem:function(a,b,c){if(typeof this.scalerOptions.color=="function"){this.ctx.fillStyle=this.scalerOptions.color(this.data[a])}this.ctx.fillText(this.data[a],b,c)}};function calcAxisValues(d,f,a,c){var b=d-f;var h=b/(a-1);var g=[];if(typeof c=="undefined"){c=toMoney}for(var e=0;e<a;e++){g.push(toMoney(d-e*h))}return g}function disableBubbleAndPreventDefault(a){if(a.preventDefault){a.preventDefault()}a.cancelBubble=true}function setTouchEventOffsetPosition(a,d){a=a||event;if(a.touches&&a.touches.length){a=a.touches[0]}else{if(a.changedTouches&&a.changedTouches.length){a=a.changedTouches[0]}}var b,c;b=a.pageX-d.x;c=a.pageY-d.y;return{offsetX:b,offsetY:c}}function crossLinesAndTipMgr(a,b){if(typeof Tip!="function"){window.Tip=function(){};window.Tip.prototype={show:function(){},hide:function(){},update:function(){}}}this.canvas=a;this.options=b}crossLinesAndTipMgr.prototype._removeTipAndCrossLines=function(){var a=this;if(a.tip){a.tip.hide()}if(a.clsMgr){a.clsMgr.removeCrossLines()}};crossLinesAndTipMgr.prototype.updateOptions=function(a){this.options=a};crossLinesAndTipMgr.prototype._onMouseOrTouchMove=function(f){f=f||event;f=getOffset(f);var g=this;var h=g.options;var a=g.canvas;var b=getPageCoord(a);var i=h.triggerEventRanges;if(f.offsetX<i.x||f.offsetX>i.x+i.width||f.offsetY<i.y||f.offsetY>i.y+i.height){g._removeTipAndCrossLines();return}var e=h.getCrossPoint(f);var d={crossPoint:e,verticalRange:{y1:i.y,y2:i.y+i.height},horizontalRange:{x1:i.x,x2:i.x+i.width},color:h.crossLineOptions.color,canvas:a};if(!g.clsMgr){var c=new crossLines(d);c.setMouseEvents(function(l){l=l||event;l=getOffset(l);var n={offsetX:l.offsetX+i.x,offsetY:parseInt(g.clsMgr.getHLine().style.top)-b.y};var m=h.getCrossPoint(n);c.updateCrossPoint(m);if(g.tip){g.tip.update(m,h.tipOptions.getTipHtml(n))}},function(l){l=l||event;l=getOffset(l);var n={offsetX:parseInt(g.clsMgr.getVLine().style.left)-b.x,offsetY:l.offsetY+i.y};var m=h.getCrossPoint(n);c.updateCrossPoint(m);if(g.tip){g.tip.update(m,h.tipOptions.getTipHtml(n))}});g.clsMgr=c}else{g.clsMgr.updateOptions(d)}g.clsMgr.drawCrossLines();if(h.tipOptions){var k=h.tipOptions;if(!g.tip){var j=new Tip({position:{x:k.position.x||false,y:k.position.y||false},size:k.size,opacity:k.opacity||80,cssClass:k.cssClass,offsetToPoint:k.offsetToPoint||30,relativePoint:{x:e.x,y:e.y},canvas:a,canvasRange:h.triggerEventRanges,innerHTML:k.getTipHtml(f)});g.tip=j}g.tip.show(e,k.getTipHtml(f))}};crossLinesAndTipMgr.prototype._touchstart=function(a){a=a||event;disableBubbleAndPreventDefault(a);var b=a.srcElement||a.target||a.relatedTarget;this.touchstartTime=new Date()};crossLinesAndTipMgr.prototype._touchmove=function(b){b=b||event;disableBubbleAndPreventDefault(b);var a=this.canvas;var d=getPageCoord(a);var f=b.srcElement||b.target||b.relatedTarget;var c=setTouchEventOffsetPosition(b,d);this._onMouseOrTouchMove(c)};crossLinesAndTipMgr.prototype._touchend=function(b){b=b||event;disableBubbleAndPreventDefault(b);var d=b.srcElement||b.target||b.relatedTarget;var a=this.canvas;var c=setTouchEventOffsetPosition(b,getPageCoord(a));this._removeTipAndCrossLines();var f=new Date();var g=f.getTime()-this.touchstartTime.getTime();if(g<200){if(typeof this.options.onClick=="function"){this.options.onClick()}}};crossLinesAndTipMgr.prototype._mouseout=function(b){var a=b||event;b=getOffset(a);var c=this;var d=c.options.triggerEventRanges;if(b.offsetX<=d.x||b.offsetX>=d.x+d.width||b.offsetY<=d.y||b.offsetY>=d.y+d.height){c._removeTipAndCrossLines();return}var f=a.toElement||a.relatedTarget||a.target;if(f){if(f==c.canvas){return}if(f==c.clsMgr.getHLine()||f==c.clsMgr.getVLine()){return}c._removeTipAndCrossLines()}};crossLinesAndTipMgr.prototype.addCrossLinesAndTipEvents=function(){var a=this.canvas;var d=this.options;var b=getPageCoord(a);if(a.addCrossLinesAndTipEvents==true){return}a.addCrossLinesAndTipEvents=true;var e=isTouchDevice();var c=this;if(e){addEvent(a,"touchstart",function(f){c._touchstart.call(c,f)});addEvent(a,"touchmove",function(f){c._touchmove.call(c,f)});addEvent(a,"touchend",function(f){c._touchend.call(c,f)})}else{addEvent(a,"mouseout",function(f){c._mouseout.call(c,f)});addEvent(a,"mousemove",function(f){c._onMouseOrTouchMove.call(c,f)});if(typeof d.onClick=="function"){addEvent(a,"click",d.onClick)}}};function addCrossLinesAndTipEvents(a,b){if(!a.crossLineAndTipMgrInstance){a.crossLineAndTipMgrInstance=new crossLinesAndTipMgr(a,b);a.crossLineAndTipMgrInstance.addCrossLinesAndTipEvents()}}function controller(a,b){this.canvas=$id(a);this.ctx=this.canvas.getContext("2d");this.region=b.region;this.bar=b.bar;this.value=b.value;this.minBarDistance=b.minBarDistance||5;this.onPositionChanged=b.onPositionChanged;this.prePaint=b.prePaint;this.isTouchDevice=isTouchDevice();this.touchFaultTolerance=b.touchFaultTolerance}controller.prototype={calcPositions:function(){var a=(this.region.width-this.bar.width);this.leftBarPosition=this.value.left*a/100+this.bar.width/2;this.rightBarPosition=this.value.right*a/100+this.bar.width/2},drawControllerPart:function(){var b=this.canvas;var c=this.ctx;c.save();var f=this.region;var a=this.bar;this.calcPositions();var d=this.leftBarPosition;var g=this.rightBarPosition;c.clearRect(f.x-1,f.y-1,f.width+1,f.height+1);if(typeof this.prePaint=="function"){this.prePaint(c)}c.lineWidth=1;c.strokeStyle=f.borderColor;c.beginPath();c.moveTo(f.x,f.y);c.lineTo(f.x,f.y+f.height);c.lineTo(f.x+d,f.y+f.height);c.lineTo(f.x+d,f.y+f.height-(f.height-a.height)/2);c.stroke();c.strokeStyle=f.borderColor;c.beginPath();c.moveTo(f.x+d,f.y+f.height/2-a.height/2);c.lineTo(f.x+d,f.y);c.lineTo(f.x,f.y);c.stroke();c.beginPath();c.moveTo(f.x+d,f.y+f.height);c.lineTo(f.x+f.width,f.y+f.height);c.lineTo(f.x+f.width,f.y);c.lineTo(f.x+g,f.y);c.lineTo(f.x+g,f.y+f.height/2-a.height/2);c.stroke();c.beginPath();c.moveTo(f.x+g,f.y+f.height/2+a.height/2);c.lineTo(f.x+g,f.y+f.height);c.stroke();c.beginPath();c.fillStyle="blue";c.globalAlpha=0.5;c.rect(f.x+d,f.y,g-d,f.height);c.closePath();c.fill();c.globalAlpha=1;c.strokeStyle=a.borderColor;c.fillStyle=a.fillColor;c.beginPath();var e={x:f.x+d-a.width/2,y:f.y+f.height/2-a.height/2,width:a.width,height:a.height};c.rect(e.x,e.y,e.width,e.height);this.leftBarRegion=e;c.closePath();c.stroke();c.fill();c.beginPath();var h={x:f.x+g-a.width/2,y:f.y+f.height/2-a.height/2,width:a.width,height:a.height};c.rect(h.x,h.y,h.width,h.height);this.rightBarRegion=h;c.closePath();c.stroke();c.fill();c.restore()},setLeftBarPosition:function(a){if(a<this.bar.width/2){this.leftBarPosition=this.bar.width/2}else{if(this.rightBarPosition-a-this.minBarDistance>this.bar.width){this.leftBarPosition=a}else{this.leftBarPosition=this.rightBarPosition-this.bar.width-this.minBarDistance}}this.value=this.getValue()},setRightBarPosition:function(a){if(a<this.leftBarPosition+this.bar.width+this.minBarDistance){this.rightBarPosition=this.leftBarPosition+this.bar.width+this.minBarDistance}else{if(a>this.region.width-this.bar.width/2){this.rightBarPosition=this.region.width-this.bar.width/2}else{this.rightBarPosition=a}}this.value=this.getValue()},addControllerEvents:function(){var c=this;if(c.isTouchDevice){var a=c.canvas;addEvent(a,"touchmove",function(k){k=k||event;var p=k.srcElement||k.target||k.relatedTarget;var r=k.touches;if(!r||!r.length){return}var g=false;var f=getPageCoord(this.canvas);if(c.fingers&&c.fingers.length){for(var m=0;m<c.fingers.length;m++){var l=c.fingers[m];for(var n=0;n<r.length;n++){var q=r[n];if(q.identifier==l.id){var h=q.pageX-f.x;var o=(h-l.startX);if(o!=0){if(l.type=="left"){c.setLeftBarPosition(l.leftPosition+o)}else{if(l.type=="right"){c.setRightBarPosition(l.rightPosition+o)}else{c.setLeftBarPosition(l.leftPosition+o);c.setRightBarPosition(l.rightPosition+o)}}g=true}break}}}}if(g){c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}disableBubbleAndPreventDefault(k)});addEvent(a,"touchend",function(h){h=h||event;if(c.fingers&&c.fingers.length){if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}}else{var l=new Date().getTime()-c.touchstartTime.getTime();if(l<window.tapTimeLimit&&c.startTouch){var f=getPageCoord(c.canvas);var i=c.startTouch;var k={offsetX:i.pageX-f.x,offsetY:i.pageY-f.y};var g=(c.rightBarPosition+c.leftBarPosition)/2;var j=k.offsetX-g;c.setLeftBarPosition(c.leftBarPosition+j);c.setRightBarPosition(c.rightBarPosition+j);c.drawControllerPart();if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.startTouch=null}}c.fingers=null;disableBubbleAndPreventDefault(h)});addEvent(a,"touchstart",function(g){var o=g.touches;if(!o||!o.length){o=g.changedTouches}c.touchstartTime=new Date();c.startTouch=o[0];var m=g.srcElement||g.target||g.relatedTarget;var f=getPageCoord(c.canvas);function j(i){if(c.isOnLeftBar(i)){return"left"}if(c.isOnRightBar(i)){return"right"}if(c._isBetweenLeftAndRight(i)){return"middle"}return false}c.fingers=[];if(o.length){for(var k=0;k<o.length;k++){var n=o[k];var l={offsetX:n.pageX-f.x,offsetY:n.pageY-f.y};var p=j(l);if(!p){continue}var h={id:n.identifier,startX:n.pageX-f.x,type:p,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition};c.fingers.push(h)}}disableBubbleAndPreventDefault(g);return false})}else{var d=function(f){var g=c.isOnLeftBar(f);var h=c.isOnRightBar(f);if(c._isBetweenLeftAndRight(f)){document.body.style.cursor="pointer"}else{if(g||h||c.triggerBar){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(c.triggerBar){c.triggerBar.targetX=f.offsetX;var i=(c.triggerBar.targetX-c.triggerBar.x);if(c.triggerBar.type=="left"){document.body.style.cursor="col-resize";c.setLeftBarPosition(c.triggerBar.position+i)}else{if(c.triggerBar.type=="right"){c.setRightBarPosition(c.triggerBar.position+i)}else{c.setLeftBarPosition(c.triggerBar.leftPosition+i);c.setRightBarPosition(c.triggerBar.rightPosition+i)}}if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}c.drawControllerPart()}};var b=function(f){if(c.triggerBar){}c.triggerBar=null;document.body.style.cursor="default";if(typeof c.onPositionChanged=="function"&&c.isValueChanged()){c.value=c.getValue();c.onPositionChanged(c.value)}};var e=function(f){var g=c.isOnLeftBar(f);var i=c.isOnRightBar(f);var h=c._isBetweenLeftAndRight(f);if(h){document.body.style.cursor="pointer"}else{if(g||i){document.body.style.cursor="col-resize"}else{document.body.style.cursor="default"}}if(g){c.triggerBar={type:"left",x:f.offsetX,position:c.leftBarPosition}}else{if(i){c.triggerBar={type:"right",x:f.offsetX,position:c.rightBarPosition}}else{if(h){c.triggerBar={type:"middle",x:f.offsetX,leftPosition:c.leftBarPosition,rightPosition:c.rightBarPosition}}else{c.triggerBar=null}}}};addEvent(c.canvas,"mouseup",b);addEvent(c.canvas,"mouseout",b);addEvent(c.canvas,"mousemove",function(f){f=f||event;if(f.preventDefault){f.preventDefault()}else{f.returnValue=false}var g=getOffset(f);d(g)});addEvent(c.canvas,"mousedown",function(f){f=f||event;var g=getOffset(f);e(g)})}},isValueChanged:function(){if(typeof this.preValue=="undefined"){this.preValue=this.getValue();return false}if(isTouchDevice()&&this.latestChangeTime){var b=new Date();if(b.getTime()-this.latestChangeTime.getTime()<50){return false}}var c=this.preValue;var e=this.getValue();var a=Math.abs(e.left-c.left)+Math.abs(e.right-c.right);this.preValue=e;var d=a!=0;if(d){this.latestChangeTime=new Date()}return a!=0},_isInRegion:function(a,b){return a.offsetX>b.x&&a.offsetX<b.x+b.width&&a.offsetY>b.y&&a.offsetY<b.y+b.height},_isBetweenLeftAndRight:function(a){var c=this.region;var b={x:c.x+this.leftBarPosition+this.bar.width/2,y:c.y,width:this.rightBarPosition-this.leftBarPosition-this.bar.width,height:this.region.height};return this._isInRegion(a,b)},_getTouchFaultToleranceRegion:function(b){var a=this;if(a.isTouchDevice){b.x-=a.touchFaultTolerance/2;b.width+=a.touchFaultTolerance/2}return b},isOnLeftBar:function(a){var b=this._getTouchFaultToleranceRegion(this.leftBarRegion);return this._isInRegion(a,b)},isOnRightBar:function(a){var b=this._getTouchFaultToleranceRegion(this.rightBarRegion);return this._isInRegion(a,b)},getValue:function(){var a=this.region.width-this.bar.width;return{left:(this.leftBarPosition-this.bar.width/2)*100/a,right:(this.rightBarPosition-this.bar.width/2)*100/a}}};function convertDate(e,g){var h=Math.ceil(e/10000)-1;var b=e%100;var c=(Math.ceil(e/100)-1)%100;var a=new Date();a.setYear(h);a.setMonth(c-1);a.setDate(b);if(c<10){c="0"+c}if(b<10){b="0"+b}if(g){var f=["日","一","二","三","四","五","六"];return h+"-"+c+"-"+b+"(星期"+f[a.getDay()]+")"}else{return h+"-"+c+"-"+b}}function calcMAPrices(e,h,a,b){var f=new Array();for(var c=h;c<h+a;c++){var g=c-b+1;if(g<0){f.push(false);continue}var j=0;for(var d=g;d<=c;d++){j+=e[d].close}var l=j/b;f.push(l)}return f}var timer={start:function(a){this.startTime=new Date();this.stepName=a},stop:function(){var a=new Date().getTime()-this.startTime.getTime();setDebugMsg(this.stepName+"耗时"+a+"ms")}};function kLine(a){this.options=a;this.dataRanges=null}kLine.prototype={initialize:function(a){a.klOptions=this.options;a.implement=this},start:function(){var a=this.canvas;var c=this.ctx;this.painting=true;var e=this.klOptions;var b={width:a.width,height:e.priceLine.region.y-3};c.clearRect(0,0,b.width,b.height);c.save();window.riseColor=e.riseColor;window.fallColor=e.fallColor;window.normalColor=e.normalColor;if(e.backgroundColor&&!this.drawnBackground){c.beginPath();c.fillStyle=e.backgroundColor;c.rect(0,0,b.width,b.height);c.fill();this.drawnBackground=true}c.translate(e.region.x,e.region.y);c.strokeStyle=e.borderColor;c.beginPath();c.rect(0,0,e.region.width,e.region.height);c.stroke();var f=e.region.height/(e.horizontalLineCount+1);for(var d=1;d<=e.horizontalLineCount;d++){var j=f*d;if(j*10%10==0){j+=0.5}this.drawHLine(e.splitLineColor,0,j,e.region.width,1,e.lineStyle)}var g=e.region.width/(e.verticalLineCount+1);for(var d=1;d<=e.verticalLineCount;d++){var h=g*d;if(h*10%10==0){h+=0.5}this.drawVLine(e.splitLineColor,h,0,e.region.height,1,e.lineStyle)}},end:function(){this.ctx.restore();var l=this;var m=l.klOptions;var o=m.region;var p=m.volume.region;function g(r){r-=o.x;var q=Math.ceil(r/(l.klOptions.spaceWidth+l.klOptions.barWidth))-1;var c=l.toIndex-l.startIndex+1;if(q>=c){q=c-1}return q}function j(q){var c=g(q);return o.x+l.klOptions.spaceWidth*(c+1)+l.klOptions.barWidth*c+l.klOptions.barWidth*0.5}function h(c,q){if(q>c.preClose){return riseColor}else{if(q<c.preClose){return fallColor}else{return normalColor}}}function i(s){var c=l.startIndex+g(s);if(c>=l.data.ks.length){c=l.data.ks.length-1}if(c<0){c=0}var q=l.data.ks[c];var r="<div><b>"+convertDate(q.quoteTime)+'</b></div>昨收价：<font color="'+h(q,q.preClose)+'">'+toMoney(q.preClose)+'</font><br/>开盘价：<font color="'+h(q,q.open)+'">'+toMoney(q.open)+'</font><br/>最高价：<font color="'+h(q,q.high)+'">'+toMoney(q.high)+'</font><br/>最低价：<font color="'+h(q,q.low)+'">'+toMoney(q.low)+'</font><br/>收盘价：<font color="'+h(q,q.close)+'">'+toMoney(q.close)+"</font><br/>成交量："+bigNumberToText(q.volume/100)+"手<br/>成交额："+bigNumberToText(q.amount);return r}if(!l.crossLineAndTipMgrInstance){l.crossLineAndTipMgrInstance=new crossLinesAndTipMgr(l.canvas,{getCrossPoint:function(c){return{x:j(c.offsetX),y:c.offsetY}},triggerEventRanges:{x:o.x,y:o.y+1,width:o.width,height:p.y+p.height-o.y},tipOptions:{getTipHtml:function(c){return i(c.offsetX)},size:{width:120,height:150},position:{x:false,y:o.y+(o.height-150)/3},opacity:80,cssClass:"",offsetToPoint:30},crossLineOptions:{color:"black"}});l.crossLineAndTipMgrInstance.addCrossLinesAndTipEvents()}else{l.crossLineAndTipMgrInstance.updateOptions({getCrossPoint:function(c){return{x:j(c.offsetX),y:c.offsetY}},triggerEventRanges:{x:o.x,y:o.y+1,width:o.width,height:p.y+p.height-o.y},tipOptions:{getTipHtml:function(c){return i(c.offsetX)},size:{width:120,height:150},position:{x:false,y:o.y+(o.height-150)/3},opacity:80,cssClass:"",offsetToPoint:30},crossLineOptions:{color:"black"}})}if(l.controller==null){l.implement.paintPriceLine.call(l);var e=m.controller;var k=l.canvas.id+"_controller";var d=$id(k);var f=$id(k)!=null;if(!f){d=document.createElement("CANVAS");d.id=k;document.body.appendChild(d)}var n=l.klOptions.priceLine.region;setDebugMsg("priceRegion.width="+n.width);d.width=n.width;d.height=n.height;var b=getPageCoord(l.canvas);d.style.left=b.x+n.x+"px";d.style.top=b.y+n.y+"px";d.style.position="absolute";d.style.zIndex=(l.canvas.style.zIndex?l.canvas.style.zIndex:1)+1;d.style.display="block";var a=new controller(d.id,{region:{x:0,y:0,width:d.width,height:d.height},bar:e.bar||{width:20,height:35,borderColor:"black",fillColor:"snow"},value:{left:l.dataRanges.start,right:l.dataRanges.to},minBarDistance:e.minBarDistance||20,onPositionChanged:function(c){timer.start("drawKL");drawKL({start:c.left,to:c.right});timer.stop();l.controller.drawControllerPart()},prePaint:function(c){},touchFaultTolerance:20});this.controller=a;a.drawControllerPart();a.addControllerEvents()}else{if(l.requestController){l.requestController=false;var a=this.controller;a.drawControllerPart();a.addControllerEvents()}}if(!l.addOrentationChangedEvent){l.addOrentationChangedEvent=true;addEvent(window,"orientationchange",function(c){l.requestController=true;l.implement.onOrentationChanged.call(l)})}l.painting=false},paintItems:function(){var u=this.klOptions;var w=u.region;var q=this.data.ks.length;var s=true;if(this.dataRanges==null){var d=Math.ceil(w.width/(u.spaceWidth+u.barWidth))-1;if(d>q){d=q}this.dataRanges={start:100*(this.data.ks.length-d)/this.data.ks.length,to:100};s=false}var e=this.dataRanges;var y=Math.ceil(e.start/100*q);var A=Math.ceil(e.to/100*q)+1;if(A==q){A=q-1}this.startIndex=y;this.toIndex=A;var o=A-y+1;if(s){function n(){return(u.spaceWidth+u.barWidth)*o<=w.width}var x,a;if(n()){x=1;a=(w.width-x*o)/o;if(a>4){x=2;a=((w.width-x*o)/o)}}else{x=1;a=(w.width-x*o)/o;if(a<=2){x=0;a=(w.width-x*o)/o}else{if(a>4){x=2;a=((w.width-x*o)/o)}}}u.barWidth=a;u.spaceWidth=x}var g=[];for(var l=y;l<=A&&l<q;l++){g.push(this.data.ks[l])}var k,p;g.each(function(K,I,J){if(J==0){k=K.high;p=K.low}else{k=Math.max(K.high,k);p=Math.min(p,K.low)}});this.high=k;this.low=p;var b=this.ctx;var r=this;this.implement.paintMAs.call(this,g,j);function j(i){return(r.high-i)*w.height/(r.high-r.low)}function h(I){var J=I*(u.spaceWidth+u.barWidth)+(u.spaceWidth+u.barWidth)*0.5;if(J*10%10==0){J+=0.5}return J}var c=0;var t=u.barWidth>1.5;var f=function(Q,I,O){var P=Q.close>Q.open;var N=P?riseColor:fallColor;var R=h(O);if(c==0){c=R}else{if(R-c<1){return}}c=R;var S=j(Q.high);var J=j(Q.low);if(t){b.fillStyle=N;b.strokeStyle=N;var M,K;if(P){M=j(Q.close);K=j(Q.open)-M}else{M=j(Q.open);K=j(Q.close)-M}b.beginPath();b.moveTo(R,S);b.lineTo(R,J);b.stroke();var L=R-u.barWidth/2;b.beginPath();b.fillRect(L,M,u.barWidth,K)}else{b.strokeStyle=N;b.beginPath();b.moveTo(R,S);b.lineTo(R,J);b.stroke()}};g.each(f);var G=u.yAxis;G.region=G.region||{x:0-w.x,y:0-3,height:w.height,width:w.x-3};var F=new yAxis(G);var H=new Painter(this.canvas.id,F,calcAxisValues(k,p,(u.horizontalLineCount+2)));H.paint();var C=u.xAxis;C.region={x:0,y:w.height+2,width:w.width,height:20};var B=new xAxis(C);var E=[];var z=g.length/(u.xAxis.scalerCount-1);if(z<1){u.xAxis.scalerCount=g.length;z=1}E.push(convertDate(g[0].quoteTime,false));for(var l=1;l<u.xAxis.scalerCount;l++){var m=Math.ceil(l*z);if(m>=g.length){m=g.length-1}var v=convertDate(g[m].quoteTime,false);E.push(v)}var D=new Painter(this.canvas.id,B,E);D.paint();this.implement.paintVolume.call(this,g)},paintPriceLine:function(){if(this.hasPaintPriceLine){return}this.hasPaintPriceLine=true;var a=this.ctx;var h=this.klOptions.priceLine;var k=h.region;a.save();a.translate(k.x,k.y);a.clearRect(0-k.x,0,this.canvas.width,k.height);var l=k.height/(h.horizontalLineCount+1);for(var e=1;e<=h.horizontalLineCount;e++){var o=l*e;if(o*10%10==0){o+=0.5}this.drawHLine(h.splitLineColor,0,o,k.width,1,h.lineStyle)}var m=k.width/(h.verticalLineCount+1);for(var e=1;e<=h.verticalLineCount;e++){var n=m*e;if(n*10%10==0){n+=0.5}this.drawVLine(h.splitLineColor,n,0,k.height,1,h.lineStyle)}var f=this.data.ks;var g=f.length;var j;f.each(function(u,s,t){if(t==0){j={high:u.high,low:u.low}}else{j.high=Math.max(j.high,u.close);j.low=Math.min(j.low,u.close)}});if(j.low>1){j.low-=1}function c(s){return s*k.width/g}function d(i){return(j.high-i)*k.height/(j.high-j.low)}var b=0;f.each(function(u,s,t){var v=c(t);if(b==0){b=v}else{if(v-b<1){return}}b=v;var w=d(u.close);if(t==0){a.beginPath();a.moveTo(v,w)}else{a.lineTo(v,w)}});a.strokeStype=h.borderColor;a.stroke();a.lineTo(k.width,k.height);a.lineTo(0,k.height);a.closePath();a.fillStyle=h.fillColor;a.globalAlpha=h.alpha;a.fill();a.globalAlpha=1;var q=h.yAxis;q.region=q.region||{x:0-k.x,y:0-3,height:k.height,width:k.x-3};var p=new yAxis(q);var r=new Painter(this.canvas.id,p,calcAxisValues(j.high,j.low,(h.horizontalLineCount+2)));r.paint();a.restore()},paintMAs:function(b,c){var a=this.ctx;var f=this.klOptions;var d=f.MAs;var e=this;d.each(function(j,g,h){var i=calcMAPrices(e.data.ks,e.startIndex,b.length,j.daysCount);j.values=i;i.each(function(m,k,l){if(m){e.high=Math.max(e.high,m);e.low=Math.min(e.low,m)}})});d.each(function(j,g,h){var i=j.values;a.strokeStyle=j.color;a.beginPath();i.each(function(m,k,l){var n=l*(f.spaceWidth+f.barWidth)+(f.spaceWidth+f.barWidth)*0.5;if(!m){return}var o=c(m);if(o&&l==0){a.moveTo(n,o)}else{a.lineTo(n,o)}});a.stroke()})},paintVolume:function(b){var a=this.ctx;var g=this.klOptions;var l=g.volume;var m=l.region;a.restore();a.save();a.translate(m.x,m.y);a.globalAlpha=1;var h=m.height/(l.horizontalLineCount+1);for(var e=1;e<=l.horizontalLineCount;e++){var t=h*e;if(t*10%10==0){t+=0.5}this.drawHLine(g.splitLineColor,0,t,g.region.width,1,g.lineStyle)}var j=g.region.width/(g.verticalLineCount+1);for(var e=1;e<=g.verticalLineCount;e++){var s=j*e;if(s*10%10==0){s+=0.5}this.drawVLine(g.splitLineColor,s,0,m.height,1,g.lineStyle)}a.strokeStyle=g.borderColor;a.beginPath();a.rect(0,0,m.width,m.height);a.stroke();var f=0;b.each(function(w,u,v){f=Math.max(f,w.volume)});f*=1.05;function d(i){return m.height-m.height/f*i}function c(u){return u*(g.spaceWidth+g.barWidth)+(g.spaceWidth)*0.5}a.globalAlpha=1;b.each(function(w,u,v){var z=c(v);var A=d(w.volume);a.beginPath();a.rect(z,A,g.barWidth,m.height/f*w.volume);a.fillStyle=w.close>w.open?riseColor:fallColor;a.fill()});var k;var r;if(f<10000*100){k=10000;r="万"}else{k=10000*100;r="百万"}var q=[];q.push((f/k).toFixed(2));q.push((f/2/k).toFixed(2));q.push(r);var o=l.yAxis;o.region=o.region||{x:0-m.x,y:-3,width:m.x-3,height:m.height};var n=new yAxis(o);var p=new Painter(this.canvas.id,n,q);p.paint();a.restore();a.save()},onOrentationChanged:function(b){var g=window.orientation;function c(){return screen.width-40}if(typeof g!="undefined"){setDebugMsg("orientation="+g+",getWidth="+c());var d=this;var h=c();d.canvas.width=h;var f=d.klOptions;var a=h-f.chartMargin.left-f.chartMargin.right;d.klOptions.volume.region.width=d.klOptions.priceLine.region.width=d.klOptions.region.width=a;d.controller=null;d.hasPaintPriceLine=false;drawKL({start:d.dataRanges.start,to:d.dataRanges.to})}}};var painter;var initialWidth=Math.min(screen.width,1024)-40;function drawKL(e){var d={backgroundColor:"#fff",riseColor:"red",fallColor:"green",normalColor:"black",chartMargin:{left:45.5,top:20.5,right:20.5},region:{x:45.5,y:20.5,width:initialWidth-45.5-20.5,height:250},barWidth:5,spaceWidth:2,horizontalLineCount:7,verticalLineCount:7,lineStyle:"solid",borderColor:"gray",splitLineColor:"#eeeeee",lineWidth:1,MAs:[{color:"rgb(255,70,251)",daysCount:5},{color:"rgb(227,150,34)",daysCount:10},{color:"rgb(53,71,107)",daysCount:20}],yAxis:{font:"11px Arial",color:"black",align:"right",fontHeight:8,textBaseline:"top"},xAxis:{font:"11px Arial",color:"black",align:"right",fontHeight:8,textBaseline:"top",scalerCount:9},volume:{region:{x:45.5,y:290.5,height:80,width:initialWidth-45.5-20.5},horizontalLineCount:1,yAxis:{font:"11px Arial",color:"black",align:"right",fontHeight:8,textBaseline:"top"}},priceLine:{region:{x:45.5,y:380.5,height:60,width:initialWidth-45.5-20.5},verticalLineCount:7,horizontalLineCount:1,lineStyle:"solid",borderColor:"gray",splitLineColor:"#eeeeee",fillColor:"lightgray",alpha:0.5,yAxis:{font:"11px Arial",color:"black",align:"right",fontHeight:8,textBaseline:"top"}},controller:{bar:{width:20,height:35,borderColor:"black",fillColor:"lightgray"},minBarDistance:20}};if(!painter){var a=$id("canvasKL");if(a.width!=initialWidth){a.width=initialWidth}var c=new kLine(d);var b=getKLData();painter=new Painter("canvasKL",c,b)}painter.dataRanges=e;painter.paint()};
</script>

    
</head>
<body onload="drawKL()" style="padding:0;margin:2px">
    <canvas id="canvasKL" width="1002" height="460" style="z-index: 2; border: 1px solid #69c">
        <p>hey,您的浏览器不支持html5，用flash吧</p>
    </canvas>
    <div id="debug"></div>

    <script type="text/javascript" src="k-data.js"></script>
</body>
</html>
